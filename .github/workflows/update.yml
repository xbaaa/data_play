name: Update All Sports Data

on:
  schedule:
    # Runs every 5 minutes (Maximum frequency allowed by GitHub)
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allows manual trigger for testing

permissions:
  contents: write # Essential: Allows the action to push data back to this repo

jobs:
  run-and-publish:
    runs-on: ubuntu-latest
    
    # Set Timezone to Hong Kong so logs match your local time
    env:
      TZ: 'Asia/Hong_Kong'

    steps:
      # ----------------------------------------------------------------
      # 1. Checkout Repo
      # ----------------------------------------------------------------
      - name: Checkout Logic
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.REPO_NAME }}
          token: ${{ secrets.REPO_TOKEN }}
          path: logic # Clones the repo into a folder named 'logic'

      # ----------------------------------------------------------------
      # 2. Setup Python Environment
      # ----------------------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip' # Caches dependencies to speed up future runs

      # ----------------------------------------------------------------
      # 3. Install Dependencies & Run Script
      # ----------------------------------------------------------------
      - name: Install Dependencies
        run: |
          # Point to the file INSIDE the 'logic' folder
          pip install -r logic/requirements.txt

      - name: Run the Script
        run: |
          # The script is inside 'logic/run.py'
          # It outputs multiple .json files (e.g., basketball_facilities_data.json) into the CURRENT directory
          python logic/run.py

      # ----------------------------------------------------------------
      # 4. Commit & Push Data to "data" Branch (Orphan Strategy)
      # ----------------------------------------------------------------
      - name: Deploy Data
        run: |
          # Configure Git Identity
          git config --global user.name "PLAY"
          git config --global user.email "play@mail.com"
          
          # Switch to an orphan branch named 'data'
          # This creates a branch with NO history (prevents repo bloat)
          git checkout --orphan data
          
          # Clear the staging area
          git reset
          
          # Add ONLY the generated JSON files
          # This wildcard catches all files ending in _facilities_data.json
          git add *_facilities_data.json
          
          # Check if there are changes before committing (avoids empty commit errors)
          if git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          
          # Commit with a timestamp
          timestamp=$(date -u)
          git commit -m "Update: ${timestamp}"
          
          # Force Push to overwrite the 'data' branch completely
          git push -f origin data
